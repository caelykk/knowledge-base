### Создаем пользователя 

Для начала создадим нового пользователя:

```
sudo adduser selectelsftpclient
```

После ввода команды нужно указать пароль для нового пользователя — это обязательное действие. Все остальные предложения операционной системы о вводе дополнительной информации можно пропустить.

Настройки разрешений для нового пользователя будет производиться позже, после создания необходимых каталогов.

### Создаем каталог

Использовать домашний каталог пользователя не получится из-за особенностей политики безопасности SSH. Она требует, чтобы целевой каталог и все каталоги, находящиеся выше по иерархии, принадлежали root и не были доступны для записи кому-либо другому. Поэтому мы не можем использовать домашний каталог пользователя, так как его владельцем является сам пользователь. 

Создадим новый каталог /var/sftp/userfolder:

```
sudo mkdir -p /var/sftp/userfolder
```

Каталогу `/var/sftp` следует назначить владельцем пользователя root. `/var/sftp` является целевым каталогом, мы предоставим к нему доступ по умолчанию для `selectelsftpclient`. Иначе говоря, `selectelsftpclient` будет подключаться по SFTP на сервер, и его корневым каталогом будет каталог sftp. Он не будет владельцем /var/sftp, но будет иметь к нему доступ на чтение и выполнение. Такой вариант ограничения прав разрешен OpenSSH.

```
sudo chown root:root /var/sftp
```

Права доступа необходимо распределить следующим образом:
- root — полные права,
- остальные пользователи — чтение и выполнение.

```
sudo chmod 755 /var/sftp
```

Теперь следует изменить владельца папки, которой пользователь selectelsftpclient будет распоряжаться:

```
sudo chown selectelsftpclient:selectelsftpclient /var/sftp/userfolder
```

### Настройка доступа

Осталось лишь запретить новому пользователю доступ к терминалу, оставив возможность передачи файлов. Находясь на сервере, введите следующую команду для перехода в файл конфигурации SSH:

```
sudo nano /etc/ssh/sshd_config
```

В самый конец файла добавьте строки:

```
Match User selectelsftpclient 
ForceCommand internal-sftp 
PasswordAuthentication yes 
ChrootDirectory /var/sftp 
PermitTunnel no 
AllowAgentForwarding no 
AllowTcpForwarding no 
X11Forwarding no
```

Описание команд:
- `Match User selectelsftpclient` — SSH-сервер будет применять следующие команды только к пользователю selectelsftpclient. 
- `ForceCommand internal-sftp` — запуск SFTP-сервера сразу после входа в систему, одновременно с этим запрещается доступ к оболочке. 
- `PasswordAuthentication yes` — разрешение аутентификации по паролю для selectelsftpclient. 
- `ChrootDirectory /var/sftp/` — пользователь selectelsftpclient получает доступ только к каталогу /var/sftp/. Остальные каталоги для него заблокированы. 
- `PermitTunnel no`, `AllowAgentForwarding no`, `AllowTcpForwarding no` и `X11Forwarding no` — отключение переадресации портов, туннелирования и переадресации X11 для selectelsftpclient.

Сохраните изменения, внесенные в файл _/etc/ssh/sshd_config_, а затем сделайте перезапуск службы `sshd`:

```
Ubuntu: 
sudo systemctl restart ssh 

CentOS: 
sudo systemctl restart sshd
```

### Проверка

Для начала стоит узнать, получилось ли у нас ограничить доступ по чистому SSH на сервер:

```
ssh selectelsftpclient@ip_address
```

Если вы изменяли порт по умолчанию, не забудьте добавить в команду параметр `-p`. 

Если вы получили подобное сообщение, значит, настройка выполнена верно:

```
This service allows sftp connections only. 
Connection to your_server_ip closed.
```

Теперь следует проверить, может ли `selectelsftpclient` подключиться к серверу по протоколу SFTP:

```
sftp selectelsftpclient@ip_address
```

При использовании нестандартного порта используйте параметр `-P`.

Теперь у пользователя `selectelsftpclient` есть доступ на сервер в качестве SFTP-пользователя с ограничением доступа к оболочке. Если вам необходимо создать сразу несколько таких пользователей, вы можете поместить их в одну группу и редактировать права доступа сразу для всех, а не каждому пользователю в отдельности.

